// Pin assignments
const int tdcSensorPin = 2;
const int camshaftSensorPin = 3;
const int ignitionSignalPin = 4;  // Replace with your actual ignition signal pin
const int calibrationLedPin = 13; // Pin for calibration LED

// Enumeration for states
enum EngineState {
  CALIBRATION,
  NORMAL_OPERATION
};

// Enumeration for coils
enum Coil {
  COIL_1,
  COIL_2,
  COIL_3,
  COIL_4
};

// Variables
volatile int tdcPosition = 0;
volatile int camshaftPosition = 0;
const int camshaftToCrankshaftRatio = 2;
const int camshaftRisingEdgeAngle = 10; // Adjusted angle for camshaft rising edge
const int camshaftFallingEdgeAngle = 5; // Adjusted angle for camshaft falling edge

// Variable to track the current engine state
EngineState engineState = CALIBRATION;
int calibrationOffset = 0;  // The offset to set angle to 0 during calibration

// Variable to track the current coil to fire
Coil currentCoil = COIL_1;

// Function declarations
void determineCurrentCoil(int angle);
void fireCoil(Coil coil);
void dischargeAllCoils();
bool isIgnitionSignalRisingEdge();
bool isIgnitionSignalFallingEdge();
void printEngineAngle();

void setup() {
  pinMode(tdcSensorPin, INPUT);
  pinMode(camshaftSensorPin, INPUT);
  pinMode(ignitionSignalPin, INPUT);
  pinMode(calibrationLedPin, OUTPUT); // Calibration LED pin
  digitalWrite(calibrationLedPin, HIGH); // Turn on the LED initially
  Serial.begin(9600); // Initialize Serial communication
  attachInterrupt(digitalPinToInterrupt(tdcSensorPin), tdcInterrupt, RISING);
  attachInterrupt(digitalPinToInterrupt(camshaftSensorPin), camshaftInterrupt, CHANGE);

  // Replace the pin numbers with the actual pins connected to each coil
  const int coil1Pin = 5;  // Replace with your actual pin number
  const int coil2Pin = 6;  // Replace with your actual pin number
  const int coil3Pin = 7;  // Replace with your actual pin number
  const int coil4Pin = 8;  // Replace with your actual pin number

  // Set all coil pins to LOW initially
  digitalWrite(coil1Pin, LOW);
  digitalWrite(coil2Pin, LOW);
  digitalWrite(coil3Pin, LOW);
  digitalWrite(coil4Pin, LOW);
}

void loop() {
  switch (engineState) {
    case CALIBRATION:
      // During calibration, wait for the first TDC signal
      if (tdcPosition > 0) {
        // Calibration completed, switch to normal operation
        engineState = NORMAL_OPERATION;
        calibrationOffset = calculateCrankshaftAngle();  // Set the offset to the current angle
        digitalWrite(calibrationLedPin, HIGH); // Turn on the LED after calibration
      }
      break;

    case NORMAL_OPERATION:
      // In normal operation, proceed with regular tasks
      int crankshaftAngle = calculateCrankshaftAngle() - calibrationOffset;  // Apply the offset
      crankshaftAngle %= 360;

      // Print engine angle to Serial Monitor
      printEngineAngle(crankshaftAngle);

      // Check for ignition signal falling edge
      if (isIgnitionSignalFallingEdge()) {
        // Determine the coil to charge based on the crankshaft angle
        determineCurrentCoil(crankshaftAngle);
        // Charge the coil for the current cylinder (Set to HIGH)
        fireCoil(currentCoil);
      }

      // Check for ignition signal rising edge
      if (isIgnitionSignalRisingEdge()) {
        // Discharge all coils (Set to LOW)
        dischargeAllCoils();
      }

      // Your additional logic or tasks can go here
      break;
  }
}

void tdcInterrupt() {
  tdcPosition = 0;

  // Reset camshaft position to 0 when TDC signal is detected
  camshaftPosition = 0;

  // If in calibration state, set the state to normal operation
  if (engineState == CALIBRATION) {
    engineState = NORMAL_OPERATION;
    calibrationOffset = calculateCrankshaftAngle();  // Set the offset to the current angle
    digitalWrite(calibrationLedPin, HIGH); // Turn on the LED after calibration
  }
}

void camshaftInterrupt() {
  camshaftPosition++;
  int camshaftSignalState = digitalRead(camshaftSensorPin);

  // Use integers instead of floating-point for angle calculations
  int currentAngle = (camshaftSignalState == HIGH) ? camshaftRisingEdgeAngle : camshaftFallingEdgeAngle;
  currentAngle += camshaftPosition * 15; // Increment by 15 degrees for each tooth
  currentAngle %= 360;
}

int calculateCrankshaftAngle() {
  // Use integers for calculations
  int crankshaftAngle = (camshaftPosition * 15 * camshaftToCrankshaftRatio) - tdcPosition;
  crankshaftAngle %= 360;

  return crankshaftAngle;
}

void determineCurrentCoil(int angle) {
  // Determine the current coil based on the crankshaft angle
  if ((angle >= 330 && angle < 360) || (angle >= 0 && angle < 60)) {
    currentCoil = COIL_1;
  } else if (angle >= 240 && angle < 330) {
    currentCoil = COIL_2;
  } else if (angle >= 60 && angle < 150) {
    currentCoil = COIL_3;
  } else if (angle >= 150 && angle < 240) {
    currentCoil = COIL_4;
  }
}

void fireCoil(Coil coil) {
  // Depending on your hardware setup, you may need to use specific commands to activate the coils
  // Below is a placeholder, you should replace it with the actual commands for your hardware

  // Replace the pin numbers with the actual pins connected to each coil
  const int coil1Pin = 5;  // Replace with your actual pin number
  const int coil2Pin = 6;  // Replace with your actual pin number
  const int coil3Pin = 7;  // Replace with your actual pin number
  const int coil4Pin = 8;  // Replace with your actual pin number

  switch (coil) {
    case COIL_1:
      // Charge Coil 1 (Set to HIGH)
      digitalWrite(coil1Pin, HIGH);
      break;
    case COIL_2:
      // Charge Coil 2 (Set to HIGH)
      digitalWrite(coil2Pin, HIGH);
      break;
    case COIL_3:
      // Charge Coil 3 (Set to HIGH)
      digitalWrite(coil3Pin, HIGH);
      break;
    case COIL_4:
      // Charge Coil 4 (Set to HIGH)
      digitalWrite(coil4Pin, HIGH);
      break;
  }
}

void dischargeAllCoils() {
  // Replace the pin numbers with the actual pins connected to each coil
  const int coil1Pin = 5;  // Replace with your actual pin number
  const int coil2Pin = 6;  // Replace with your actual pin number
  const int coil3Pin = 7;  // Replace with your actual pin number
  const int coil4Pin = 8;  // Replace with your actual pin number

  // Discharge all coils (Set to LOW)
  digitalWrite(coil1Pin, LOW);
  digitalWrite(coil2Pin, LOW);
  digitalWrite(coil3Pin, LOW);
  digitalWrite(coil4Pin, LOW);
}

bool isIgnitionSignalRisingEdge() {
  static bool lastIgnitionSignalState = HIGH;  // Assuming HIGH as the default state
  bool currentIgnitionSignalState = digitalRead(ignitionSignalPin);

  // Check for rising edge
  if (lastIgnitionSignalState == LOW && currentIgnitionSignalState == HIGH) {
    // Rising edge detected
    lastIgnitionSignalState = currentIgnitionSignalState;
    return true;
  }

  lastIgnitionSignalState = currentIgnitionSignalState;
  return false;
}

bool isIgnitionSignalFallingEdge() {
  static bool lastIgnitionSignalState = HIGH;  // Assuming HIGH as the default state
  bool currentIgnitionSignalState = digitalRead(ignitionSignalPin);

  // Check for falling edge
  if (lastIgnitionSignalState == HIGH && currentIgnitionSignalState == LOW) {
    // Falling edge detected
    lastIgnitionSignalState = currentIgnitionSignalState;
    return true;
  }
  lastIgnitionSignalState = currentIgnitionSignalState;
  return false;
}

void printEngineAngle(int angle) {
  // Print engine angle to Serial Monitor
  Serial.print("Engine Angle: ");
  Serial.println(angle);
}
